Analise de complexidade de funções do sistema:


1) Gerar novas cobrancas e atualizar plano
@Transactional
public void gerarNovasCobrancasEAtualizarPlanoUsuario(LocalDateTime now) {
    log.info("Iniciando geração de novas cobranças em {}", now);
    Pageable pageRequest = PageRequest.of(0, batchSize);
    Page<PlanoCobranca> page;
    LocalDate localDateNow = now.toLocalDate();
    do {
        page = planoCobrancaRepository.findPagasComProximaNaoGerada(localDateNow, pageRequest);
        log.info("Processando {} cobranças pagas com próxima não gerada", page.getNumberOfElements());

        for (PlanoCobranca cobranca: page.getContent()) {
            planoUsuarioService.gerarProximaCobranca(cobranca);
        }

        pageRequest = pageRequest.next();
    } while (!page.isLast());
    log.info("Finalizada geração de novas cobranças");
}

2) Processar Inadimplencias
@Transactional
public void processarInadimplencias(LocalDateTime now) {
    log.info("Iniciando processamento de inadimplências em {}", now);
    Pageable pageRequest = PageRequest.of(0, batchSize);
    Page<PlanoCobranca> page;
    LocalDate localDateNow = now.toLocalDate();
    do {
        page = planoCobrancaRepository.findVencidasNaoProcessadas(localDateNow, pageRequest);
        log.info("Processando {} cobranças vencidas não processadas", page.getNumberOfElements());
        
        for (PlanoCobranca cobranca: page.getContent()) {
            planoUsuarioService.processarInadimplencia(cobranca);
        }

        pageRequest = pageRequest.next();
    } while (!page.isLast());
    log.info("Finalizado processamento de inadimplências");
}

3) Função utilitaria para ver se usuario tem uma entre algumas roles  
public static boolean hasAnyRole(Role... roles) {
    Collection<? extends GrantedAuthority> authorities = SecurityContextHolder.getContext()
            .getAuthentication()
            .getAuthorities();
    
    for (Role role : roles) {
        if (authorities.contains(new SimpleGrantedAuthority("ROLE_" + role.name()))) {
            return true;
        }
    }
    return false;
}

4) Função utilitaria que verificar se usuario tem todas as roles dentro de uma lista de roles
public static boolean hasAllRoles(Role... roles) {
    Collection<? extends GrantedAuthority> authorities = SecurityContextHolder.getContext()
            .getAuthentication()
            .getAuthorities();
    
    for (Role role : roles) {
        if (!authorities.contains(new SimpleGrantedAuthority("ROLE_" + role.name()))) {
            return false;
        }
    }
    return true;
}

5) Retorno de Cobranças do usuario mapeadas em DTO
@GetMapping
@PreAuthorize("hasAnyRole('CUSTOMER')")
public ResponseEntity<Page<PlanoCobrancaCustomerResponse>> getCustomerCobrancas(
        Pageable pageable) throws JsonProcessingException {
    Page<PlanoCobrancaCustomerResponse> cobrancas = planoCobrancaService.findCobrancasByUsuarioId(SecurityUtils.getCurrentUserId(), pageable)
            .map(PlanoCobrancaCustomerResponse::fromEntity);
    return ResponseEntity.ok(cobrancas);
}

